<!DOCTYPE html>
<html>
<head>
 <title>OSC / WebSocket Test</title>
 <meta charset="UTF-8">
 <style>
/*
button {
    min-width: 22px;
    min-height: 22px;
}
*/

/* when softkey buttons are empty (blank text returned from Eos) they shrink to be too small, but also the vertical alignment goes off (I guess because there's no text contect to align to the bottom of the (text) line..?) */
/* so (one) solution is to put some non-breaking whitespace in before or after the content of the button, so that it's never empty */
/* better yet, do it before *and* after, so that horizontal align doesn't go squiffy!.. */
/* non-breaking space in css: https://stackoverflow.com/a/8595802 */
#softkeys button:before, #softkeys button:after {
    content: "\a0";
}
/* and then maybe reduce the left and right padding (default: 6px), to reduce the width of the buttons... */
#softkeys button {
    padding-left: 2px;
    padding-right: 2px;
}

.slider.horizontal {
    width:100px;
    height:10px;
    background:#eee;
    border: solid 1px black;
    display: inline-block;
}

.slider.horizontal span {
    width:50%;
    height:100%;
    background:#ff0;
    border: solid 1px black;
    display: block;
    margin: -1px;
}
 </style>
</head>

<body onload="pageLoaded()">
 <h1>OSC WebSocket Test</h1>

 <div id="socketStatus">
  <p>
    <span id="socketStatusLabel">Socket Status:</span>
    <span id="socketStatusStatus">???</span>
    <button onclick="connectWebSocket()">Re-connect WebSocket</button>
  </p>
  <p>
    <button onclick="sendIonPing()">OSC Ping (Client -> Ion)</button>
    <span>Ping Time:</span>
    <span id="pingTime">???</span>
  </p>
 </div>

 <div id="messageArea">
  <span id="messageLabel">OSC Message:</span>
  <pre id="address">???</pre>
  <pre id="args">???</pre>
 </div>

 <div>
  Command Line: <span data-osc-update-html="/eos/out/cmd">???</span><br>
  Background Command Line: <span data-osc-update-html="/eos/out/user/0/cmd">???</span><br>
  Current Cue: <span data-osc-update-html="/eos/out/active/cue/text">???</span><br>
  Progress: <span class="slider horizontal"><span data-osc-update-width="/eos/out/active/cue"></span></span><br>
  Pending Cue: <span data-osc-update-html="/eos/out/pending/cue/text">???</span><br>
  Next Cue: <span data-osc-update-html="/eos/out/pending/cue/text">???</span><br>
  User: <span data-osc-update-html="/eos/out/user">???</span><br>
 </div>

 <div>
  <button data-osc-send="/eos/key/1" onclick="sendOSCclick(this)">1</button>
  <button data-osc-send="/eos/key/2" onclick="sendOSCclick(this)">2</button>
  <button data-osc-send="/eos/key/3" onclick="sendOSCclick(this)">3</button>
  <button data-osc-send="/eos/key/4" onclick="sendOSCclick(this)">4</button>
  <button data-osc-send="/eos/key/5" onclick="sendOSCclick(this)">5</button>
  <button data-osc-send="/eos/key/6" onclick="sendOSCclick(this)">6</button>
  <button data-osc-send="/eos/key/7" onclick="sendOSCclick(this)">7</button>
  <button data-osc-send="/eos/key/8" onclick="sendOSCclick(this)">8</button>
  <button data-osc-send="/eos/key/9" onclick="sendOSCclick(this)">9</button>
  <button data-osc-send="/eos/key/0" onclick="sendOSCclick(this)">0</button>
 </div>

 <div id="softkeys">
  <button data-osc-send="/eos/softkey/1" data-osc-update-html="/eos/out/softkey/1" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/2" data-osc-update-html="/eos/out/softkey/2" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/3" data-osc-update-html="/eos/out/softkey/3" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/4" data-osc-update-html="/eos/out/softkey/4" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/5" data-osc-update-html="/eos/out/softkey/5" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/6" data-osc-update-html="/eos/out/softkey/6" onclick="sendOSCclick(this)">???</button>
  <br>
  <button data-osc-send="/eos/softkey/7" data-osc-update-html="/eos/out/softkey/7" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/8" data-osc-update-html="/eos/out/softkey/8" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/9" data-osc-update-html="/eos/out/softkey/9" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/10" data-osc-update-html="/eos/out/softkey/10" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/11" data-osc-update-html="/eos/out/softkey/11" onclick="sendOSCclick(this)">???</button>
  <button data-osc-send="/eos/softkey/12" data-osc-update-html="/eos/out/softkey/12" onclick="sendOSCclick(this)">???</button>
 </div>

 <div>
  <button onclick="sendOSCclick2('/eos/user', 0)">User 0</button>
  <button onclick="sendOSCclick2('/eos/user', 1)">User 1</button>
  <button data-osc-send="/eos/user" onclick="sendOSCclick(this, 2)">User 2</button>
 </div>


 <script type="text/javascript">

var osc = {};
osc.socket = { readyState: -1 };
osc.id = undefined;
osc.elements = {};
osc.elements.socketStatusStatus = document.getElementById("socketStatusStatus");
osc.elements.address = document.getElementById("address");
osc.elements.args = document.getElementById("args");

function pageLoaded() {
    connectWebSocket();
    scanOSCElements();
}

function connectWebSocket() {
    // Create WebSocket connection.
    console.log('Creating WebSocket...');
    if (osc.socket.readyState == WebSocket.OPEN || osc.socket.readyState == WebSocket.CONNECTING) {
      console.log('Closing old WebSocket...');
      osc.socket.close();
    }
    osc.elements.socketStatusStatus.innerHTML = "Connecting...";
    osc.socket = new WebSocket('ws://192.168.1.2:8081');

    // Connection opened
    osc.socket.onopen = function (event) {
      console.log('WebSocket open');
      osc.elements.socketStatusStatus.innerHTML = "Open";
      if ( osc.id === undefined ) {
        osc.socket.send(JSON.stringify(['id']));
        osc.socket.send(JSON.stringify(['osc', 'open', 'eos', 'tcp', '1.0', '10.101.100.101', 3036]));
      } else {
        osc.socket.send(JSON.stringify(['id', osc.id]));
      }
    }

    // Listen for messages
    osc.socket.onmessage = function (event) {
      message = JSON.parse(event.data)[0];
      console.log('Message from server:', message);
      switch (message[0]) {
        case 'osc':
          osc.elements.address.innerHTML = message[3].address;
          osc.elements.args.innerHTML = JSON.stringify(message[3].args);
          
          if ( osc.addresses[message[3].address] !== undefined ) {
            osc.addresses[message[3].address].forEach( function (item, index, list) {
              item.func(item.element, message[3].args);
            });
          }
          break;
        case 'id':
          osc.id = message[1];
          break;
      }
    }

    // Connection closed
    osc.socket.onclose = function (event) {
      console.log('WebSocket closed (was: '+osc.elements.socketStatusStatus.innerHTML+')');
      osc.elements.socketStatusStatus.innerHTML = "Closed ("+osc.elements.socketStatusStatus.innerHTML+")";
    }

    // Connection error
    osc.socket.onerror = function (event) {
      console.log('WebSocket error', event);
      osc.elements.socketStatusStatus.innerHTML = "Error";
    }
}


function sendOSCpress(that) {
    sendOSC( { address: that.dataset.oscSend, args: 1 } );
}

function sendOSCrelease(that) {
    sendOSC( { address: that.dataset.oscSend, args: 0 } );
}

function sendOSCclick(that, args) {
    if ( args === undefined) {
      sendOSC( { address: that.dataset.oscSend } );
    } else {
      sendOSC( { address: that.dataset.oscSend, args: args } );
    }
}

function sendOSCclick2(addr, args) {
    if ( args === undefined) {
      sendOSC( { address: addr } );
    } else {
      sendOSC( { address: addr, args: args } );
    }
}

function sendOSC(message) {
    switch(osc.socket.readyState) {
      case WebSocket.OPEN:
        console.log('Sending OSC message:', message);
        osc.socket.send(JSON.stringify(['osc', 'send', 'eos', message]));
        break;
      case WebSocket.CONNECTING:
        console.log('WebSocket in CONNECTING state - unable to send OSC message (yet):', message);
        break;
      case WebSocket.CLOSING:
        console.log('WebSocket in CLOSING state - unable to send OSC message:', message);
        break;
      case WebSocket.CLOSED:
        console.log('WebSocket in CLOSED state - unable to send OSC message:', message);
        break;
      case -1:
        console.log('WebSocket not yet initialised - unable to send OSC message:', message);
        break;
      default:
        console.log('WebSocket in unknown state ('+socket.readyState+') - unable to send OSC message:', message);
    }
}



function updateOSCElementHTML(element, messageArgs) {
    element.innerHTML = messageArgs[0];
}

function updateOSCElementWidth(element, messageArgs) {
    element.style.width = messageArgs[0]*100 + "%";
}

function scanOSCElements() {
    console.log('Scanning page for OSC elements...');
    osc.addresses = {};
    // document.querySelectorAll(".oscUpdate").forEach(storeOSCElement);
    document.querySelectorAll("[data-osc-update-html]").forEach(function (element, index, nodeList) {
      if ( osc.addresses[element.dataset.oscUpdateHtml] === undefined) osc.addresses[element.dataset.oscUpdateHtml] = [];
      osc.addresses[element.dataset.oscUpdateHtml].push({func: updateOSCElementHTML, element: element});
    });
    document.querySelectorAll("[data-osc-update-width]").forEach(function (element, index, nodeList) {
      if ( osc.addresses[element.dataset.oscUpdateWidth] === undefined) osc.addresses[element.dataset.oscUpdateWidth] = [];
      osc.addresses[element.dataset.oscUpdateWidth].push({func: updateOSCElementWidth, element: element});
    });
    if ( osc.addresses["/eos/out/ping"] === undefined) osc.addresses["/eos/out/ping"] = [];
    osc.addresses["/eos/out/ping"].push({func: updatePingTime, element: document.getElementById("pingTime")});
    console.log('Found elements interested in the following OSC addresses:', osc.addresses);
}


function sendIonPing() {
    var currentTime = new Date();
    sendOSC( { address: "/eos/ping", args: ""+currentTime.getTime() } );
}
function updatePingTime(element, messageArgs) {
    var currentTime = new Date();
    console.log('Ping Sent Time:', messageArgs[0]);
    console.log('Ping Received Time:', currentTime.getTime());
    console.log('Ping Time:', (currentTime.getTime() - messageArgs[0]));
    element.innerHTML = (currentTime.getTime() - messageArgs[0]) + "mS";
}

 </script>

</body>
</html>
